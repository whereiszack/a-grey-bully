<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seattle Snack Tracker</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: white; }
        #map { position: absolute; inset: 0; z-index: 1; }
        #kennel-view { position: absolute; inset: 0; background: #000; z-index: 20; display: none; }
        #scrim { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10; display: none; pointer-events: none; }
        #hud { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        .interactive { pointer-events: auto; }
        
        .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; }
        .stat-card { background: rgba(0,0,0,0.9); border: 2px solid #ffcc33; padding: 10px; border-radius: 8px; text-align: center; color: #ffcc33; min-width: 100px; }
        #save-btn { background: #ff3333; color: white; border: none; width: 100%; margin-top: 8px; padding: 8px; font-weight: bold; border-radius: 4px; cursor: pointer; }
        
        .nav-tabs { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .btn-tab { background: #4ecdc4; color: black; border: none; padding: 12px 20px; font-weight: bold; border-radius: 6px; cursor: pointer; }
        .btn-clean { background: #ff3333; color: white; border: none; padding: 12px 20px; font-weight: bold; border-radius: 6px; cursor: pointer; }
        
        #mission-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .popup-box { border: 4px solid #ffcc33; padding: 40px; background: #111; border-radius: 15px; }

        /* Igloo Styling */
        .igloo-marker { 
            width: 32px; height: 32px; background: #eef; border-radius: 50% 50% 5% 5%; border: 2px solid #99c; 
            position: relative; z-index: 10 !important; box-shadow: inset -4px -4px 8px #ccd;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .igloo-marker::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 40%; height: 8px; background: #334; border-radius: 4px 4px 0 0; }
        
        /* Controlled Vertical Jump & Scale */
        .wiggle { 
            transform: translateY(-80px) scale(2.0) !important; 
            z-index: 100 !important; 
        }

        .poop-marker { font-size: 34px; z-index: 2 !important; cursor: pointer; pointer-events: auto; }
        
        #crosshair-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 15; }
        .ring { width: 140px; height: 140px; border: 3px solid #00ff00; border-radius: 50%; position: relative; box-shadow: 0 0 20px #00ff00; }
        #cancel-x { position: absolute; top: -50px; left: -50px; background: #ff3333; color: white; width: 44px; height: 44px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="kennel-view"></div>
<div id="scrim"></div>

<div id="hud">
    <div class="top-bar">
        <button class="btn-tab interactive" style="background:#ffcc33" onclick="toggleMode(true)">âž• LOG SNACK</button>
        <div class="stat-card">
            <div style="font-size:10px">YARD SNACKS</div>
            <div id="count" style="font-size:24px; font-weight:bold;">0</div>
            <button id="save-btn" class="interactive" onclick="syncData()">SAVE</button>
        </div>
    </div>
    <div id="crosshair-ui">
        <div id="cancel-x" class="interactive" onclick="toggleMode(false)">âœ•</div>
        <div class="ring interactive" onclick="dropSnack()"></div>
    </div>
    <div class="nav-tabs">
        <button class="btn-tab interactive" onclick="showTab('map')">YARD</button>
        <button class="btn-tab interactive" onclick="showTab('kennel')">KENNEL</button>
        <button id="clean-btn" class="btn-clean interactive" onclick="clearYard()">YARD CLEANED!</button>
    </div>
</div>

<div id="mission-popup" class="interactive" onclick="this.style.display='none'">
    <div class="popup-box">
        <h1 style="color:#ffcc33; margin:0; font-size:32px;">MISSION SUCCESS</h1>
        <p style="font-size:18px; margin:20px 0;">Snack Patrol Complete!</p>
        <p style="color:#666; font-size:12px;">TAP TO DISMISS</p>
    </div>
</div>

<script>
    const API_KEY = "$2a$10$wDnQ92WEN9Bn.45gW7/Yz.kl3VaGduq9aa88sDptssEZHta.NekPy";
    const BIN_ID = "694fc0c8d0ea881f40433700";
    
    // Centers IGLOO on screen while property is shifted
    const IGLOO_LOC = { lng: -122.316167, lat: 47.490222 };
    // Shift: Lng is decreased (West) by ~0.0001 to move property RIGHT on screen
    const VIEW_CENTER = { lng: -122.316317, lat: 47.490322 }; 

    let markers = [];
    let iglooEl;

    mapboxgl.accessToken = 'pk.eyJ1Ijoid2hlcmVpc3phY2siLCJhIjoiY21qbnZwbG9iM2V4aTNmb3d6eTNraHVkbiJ9.PUnVuym3IhJC7bviDHAa4A';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9',
        center: [VIEW_CENTER.lng, VIEW_CENTER.lat],
        zoom: 19.5,
        bearing: 270 
    });

    map.on('load', () => {
        iglooEl = document.createElement('div');
        iglooEl.className = 'igloo-marker';
        new mapboxgl.Marker({ element: iglooEl }).setLngLat([IGLOO_LOC.lng, IGLOO_LOC.lat]).addTo(map);
        loadFromCloud();
    });

    function toggleMode(active) {
        document.getElementById('crosshair-ui').style.display = active ? 'block' : 'none';
        document.getElementById('scrim').style.display = active ? 'block' : 'none';
    }

    function updateCounter() {
        const displayCount = Math.max(0, markers.length - 1);
        document.getElementById('count').innerText = displayCount;
    }

    function dropSnack() {
        createMarker(map.getCenter().lng, map.getCenter().lat);
        toggleMode(false);
        markUnsaved();
    }

    function createMarker(lng, lat) {
        const el = document.createElement('div');
        el.className = 'poop-marker'; el.innerHTML = 'ðŸ’©';
        const m = new mapboxgl.Marker({ element: el }).setLngLat([lng, lat]).addTo(map);
        
        el.onclick = (e) => {
            e.stopPropagation();
            m.remove();
            markers = markers.filter(x => x !== m);
            updateCounter();
            markUnsaved();
        };

        markers.push(m);
        updateCounter();
    }

    function markUnsaved() {
        const b = document.getElementById('save-btn');
        b.innerText = "SAVE *"; b.style.background = "#ff3333";
    }

    async function syncData() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "SYNCING...";
        
        // SAVE markers, don't clear them!
        const payload = markers.map(m => ({ lng: m.getLngLat().lng, lat: m.getLngLat().lat }));
        if (payload.length === 0) payload.push(IGLOO_LOC);

        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Bin-Versioning': 'false' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                iglooEl.classList.add('wiggle');
                setTimeout(() => iglooEl.classList.remove('wiggle'), 1000);
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                btn.innerText = "SAVED âœ“"; btn.style.background = "#28a745";
                setTimeout(() => { document.getElementById('mission-popup').style.display = 'flex'; }, 1500);
            }
        } catch (e) { btn.innerText = "SAVE"; }
    }

    function clearYard() {
        markers.forEach(m => m.remove());
        markers = [];
        createMarker(IGLOO_LOC.lng, IGLOO_LOC.lat);
        syncData(); 
    }

    function showTab(t) {
        document.getElementById('kennel-view').style.display = (t === 'kennel') ? 'block' : 'none';
        document.getElementById('clean-btn').style.display = (t === 'kennel') ? 'none' : 'block';
        if(t === 'kennel' && !window.threeInited) initKennel();
    }

    // (Kennel init code remains the same for brevity)
    function initKennel() {
        window.threeInited = true;
        const scn = new THREE.Scene();
        const cam = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        const rnd = new THREE.WebGLRenderer({ antialias: true });
        rnd.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('kennel-view').appendChild(rnd.domElement);
        const goldMat = new THREE.MeshStandardMaterial({ color: 0xffcc33, metalness: 1.0, roughness: 0.15 });
        const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
        const ctx = canvas.getContext('2d'); ctx.fillStyle = '#1a331a'; ctx.fillRect(0,0,128,128);
        for(let i=0; i<400; i++){ ctx.fillStyle = '#2d5a2d'; ctx.fillRect(Math.random()*128, Math.random()*128, 2, 4); }
        const grassTex = new THREE.CanvasTexture(canvas); grassTex.wrapS = grassTex.wrapT = THREE.RepeatWrapping; grassTex.repeat.set(10,10);
        const grnd = new THREE.Mesh(new THREE.PlaneGeometry(12.5, 12.5), new THREE.MeshStandardMaterial({map: grassTex})); 
        grnd.rotation.x = -Math.PI/2; grnd.position.y = -1.76; scn.add(grnd);
        const ped = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.8, 0.5, 32), goldMat); ped.position.y = -1.5; scn.add(ped);
        const fence = new THREE.Group();
        const railGeo = new THREE.BoxGeometry(12, 0.08, 0.08);
        const pick = new THREE.BoxGeometry(0.12, 1.1, 0.06);
        for(let i=0; i<4; i++) {
            const side = new THREE.Group();
            for(let j=-6; j<=6; j+=0.4) { const p = new THREE.Mesh(pick, goldMat); p.position.x = j; side.add(p); }
            const tR = new THREE.Mesh(railGeo, goldMat); tR.position.y = 0.4; side.add(tR);
            const bR = new THREE.Mesh(railGeo, goldMat); bR.position.y = -0.4; side.add(bR);
            side.position.z = 6; side.rotation.y = (Math.PI/2)*i;
            if(i===1) side.position.set(6,0,0); if(i===2) side.position.set(0,0,-6); if(i===3) side.position.set(-6,0,0);
            fence.add(side);
        }
        fence.position.y = -1.2; scn.add(fence);
        scn.add(new THREE.AmbientLight(0xffffff, 0.6));
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.2); mainLight.position.set(5,10,7); scn.add(mainLight);
        const fillLight = new THREE.PointLight(0xffffff, 0.8); fillLight.position.set(-5, 2, -5); scn.add(fillLight);
        new THREE.GLTFLoader().load('https://raw.githubusercontent.com/whereiszack/a-grey-bully/main/Briggs.glb', (g) => {
            const briggs = g.scene; briggs.position.y = -1.25;
            briggs.traverse(n => { if(n.isMesh) n.material = goldMat; }); scn.add(briggs);
        });
        cam.position.set(0, 2, 12);
        const ctrl = new THREE.OrbitControls(cam, rnd.domElement);
        ctrl.maxDistance = 15; ctrl.minDistance = 3; ctrl.maxPolarAngle = Math.PI / 2.1;
        function anim() { requestAnimationFrame(anim); rnd.render(scn, cam); }
        anim();
    }

    function loadFromCloud() {
        fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest?meta=false&t=${Date.now()}`, {
            headers: { 'X-Master-Key': API_KEY }
        }).then(r => r.json()).then(data => {
            const pts = Array.isArray(data) ? data : (data.record || []);
            if (pts.length === 0) createMarker(IGLOO_LOC.lng, IGLOO_LOC.lat);
            else pts.forEach(p => createMarker(p.lng, p.lat));
        });
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seattle Snack Tracker</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* HUD LAYER - ALWAYS ON TOP */
        #hud { position: absolute; inset: 0; pointer-events: none; z-index: 999; }
        .interactive { pointer-events: auto; }

        /* Top Controls */
        .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-card { background: rgba(0,0,0,0.85); border: 2px solid #ffcc33; padding: 10px; border-radius: 8px; text-align: center; min-width: 120px; color: #ffcc33; }
        
        /* Buttons */
        .btn-main { background: #ffcc33; color: #000; border: none; padding: 12px 20px; font-weight: bold; border-radius: 6px; cursor: pointer; text-transform: uppercase; }
        .btn-save { background: #ff3333; color: #fff; width: 100%; margin-top: 8px; border: none; padding: 10px; border-radius: 4px; font-weight: bold; }
        .btn-clean { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #ff3333; color: white; padding: 16px 32px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }

        /* Crosshair System */
        #crosshair-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
        .crosshair-ring { width: 120px; height: 120px; border: 4px solid #00ff00; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 0 15px #00ff00; }
        .crosshair-ring::before { content: ''; position: absolute; width: 30px; height: 4px; background: #00ff00; }
        .crosshair-ring::after { content: ''; position: absolute; width: 4px; height: 30px; background: #00ff00; }
        
        #cancel-btn { position: absolute; top: -50px; left: -50px; background: #ff3333; color: white; width: 50px; height: 50px; border-radius: 50%; border: 3px solid white; font-size: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Celebrations */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; color: #ffcc33; z-index: 1000; text-align: center; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="hud">
    <div class="top-bar">
        <button class="btn-main interactive" onclick="setMode(true)">âž• LOG SNACK</button>
        <div class="stat-card">
            <div style="font-size: 12px; margin-bottom: 4px;">SNACKS</div>
            <div id="count" style="font-size: 24px; font-weight: bold;">0</div>
            <button id="save-btn" class="btn-save interactive" onclick="syncData()">SAVE</button>
        </div>
    </div>

    <div id="crosshair-container">
        <button id="cancel-btn" class="interactive" onclick="setMode(false)">âœ•</button>
        <div class="crosshair-ring interactive" onclick="dropSnack()"></div>
    </div>

    <button class="btn-clean interactive" onclick="clearYard()">YARD CLEANED!</button>
</div>

<div id="overlay" onclick="this.style.display='none'">
    <h1 style="font-size: 48px; margin: 0;">CLEAN!</h1>
    <p style="color: white;">DATABASE ZEROED</p>
    <p style="color: #666; margin-top: 20px;">TAP TO DISMISS</p>
</div>

<script>
    const API_KEY = "$2a$10$wDnQ92WEN9Bn.45gW7/Yz.kl3VaGduq9aa88sDptssEZHta.NekPy";
    const BIN_ID = "694fc0c8d0ea881f40433700";
    let markers = [];

    mapboxgl.accessToken = 'pk.eyJ1Ijoid2hlcmVpc3phY2siLCJhIjoiY21qbnZwbG9iM2V4aTNmb3d6eTNraHVkbiJ9.PUnVuym3IhJC7bviDHAa4A';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9',
        center: [-122.316167, 47.490222],
        zoom: 19.5,
        bearing: 270, // Adjusted for East-at-top
        pitch: 0,
        antialias: true
    });

    function setMode(active) {
        document.getElementById('crosshair-container').style.display = active ? 'block' : 'none';
    }

    function dropSnack() {
        const { lng, lat } = map.getCenter();
        createMarker(lng, lat);
        setMode(false);
        const sBtn = document.getElementById('save-btn');
        sBtn.innerText = "SAVE *";
        sBtn.style.background = "#ff3333";
    }

    function createMarker(lng, lat) {
        const el = document.createElement('div');
        el.innerHTML = 'ðŸ’©';
        el.style.fontSize = '40px';
        el.style.filter = 'drop-shadow(0 0 5px rgba(0,0,0,0.5))';
        
        const m = new mapboxgl.Marker({ element: el }).setLngLat([lng, lat]).addTo(map);
        markers.push(m);
        document.getElementById('count').innerText = markers.length;
    }

    async function syncData() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "SYNCING...";
        
        const payload = markers.map(m => ({ lng: m.getLngLat().lng, lat: m.getLngLat().lat }));

        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Bin-Versioning': 'false' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                btn.innerText = "SAVED âœ“";
                btn.style.background = "#28a745";
                return true;
            }
        } catch (e) { btn.innerText = "ERROR"; }
        return false;
    }

    async function clearYard() {
        markers.forEach(m => m.remove());
        markers = [];
        document.getElementById('count').innerText = "0";
        
        const ok = await syncData();
        if (ok) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.7 } });
            document.getElementById('overlay').style.display = 'flex';
        }
    }

    map.on('load', () => {
        fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest?meta=false&t=${Date.now()}`, {
            headers: { 'X-Master-Key': API_KEY }
        })
        .then(r => r.json())
        .then(data => {
            const points = Array.isArray(data) ? data : (data.record || []);
            points.forEach(p => createMarker(p.lng, p.lat));
        });
    });
</script>
</body>
</html>
